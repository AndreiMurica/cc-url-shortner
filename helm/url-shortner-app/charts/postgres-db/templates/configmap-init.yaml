apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.initScript.configMapName }}
  labels:
    app: {{ include "postgres-db.name" . }}
data:
  create_db.sql: |
    CREATE TABLE users (
      user_id SERIAL PRIMARY KEY,
      username VARCHAR(50) NOT NULL UNIQUE,
      password_hash VARCHAR(255) NOT NULL,
      email VARCHAR(100) NOT NULL UNIQUE,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX idx_users_email ON users (email);

    CREATE TABLE short_urls (
      url_id SERIAL PRIMARY KEY,
      short_code VARCHAR(10) UNIQUE NOT NULL,
      long_url TEXT NOT NULL,
      click_count INTEGER DEFAULT 0
    );

    CREATE INDEX idx_urls_short_code ON short_urls (short_code);

    CREATE TABLE users_urls (
      user_id INTEGER NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
      url_id INTEGER NOT NULL REFERENCES short_urls(url_id) ON DELETE CASCADE,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      PRIMARY KEY (user_id, url_id)
    );
